<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Portal da Turma — Exercícios e Entregas</title>
<style>
  :root{--card-bg:#fff;--muted:#666;--accent:#2563eb}
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:18px; max-width:1100px;}
  h1{text-align:center;margin-bottom:8px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card-bg);border:1px solid #e6e6e6;padding:14px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
  label{font-weight:600;font-size:13px}
  input,select,textarea,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid #d0d0d0;box-sizing:border-box}
  textarea{min-height:80px;resize:vertical}
  button{cursor:pointer;background:var(--accent);color:#fff;border:none}
  .muted{color:var(--muted);font-size:13px}
  .left{flex:1 1 360px}.right{flex:1 1 520px}
  .exercise{border:1px solid #f0f0f0;padding:12px;margin:12px 0;border-radius:8px}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn-ghost{background:#fff;color:var(--accent);border:1px solid #cfe0ff}
  .file-btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#f3f4f6;color:#111;border:1px dashed #cfcfcf;cursor:pointer}
  .small{font-size:13px}
  .solutions{background:#fbfbfd;border:1px solid #f0f0f5;padding:8px;border-radius:8px;margin-top:10px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .top-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .danger{background:#ef4444}
  footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
  @media(max-width:800px){.left,.right{flex:1 1 100%}}
</style>
</head>
<body>

<h1>PORTAL DA TURMA — Exercícios e Entregas</h1>

<div class="top-controls card">
  <div>
    <label>Você é:</label><br>
    <select id="roleSelect">
      <option value="student">Aluno</option>
      <option value="teacher">Professor</option>
    </select>
  </div>

  <div>
    <label>Filtrar Disciplina:</label><br>
    <select id="filterSubject">
      <option value="">— Todas —</option>
    </select>
  </div>

  <div style="flex:1">
    <label>Pesquisar (título / descrição):</label><br>
    <input id="searchInput" placeholder="Pesquisar...">
  </div>

  <div style="margin-left:auto">
    <label>Opções:</label><br>
    <button id="clearStorageBtn" class="btn-ghost" style="background:#fff;color:#333;border:1px solid #eee">Limpar dados</button>
  </div>
</div>

<div class="row">
  <!-- FORMULÁRIOS -->
  <div class="card left" id="leftCard">
    <!-- PROFESSOR -->
    <div id="teacherForm" style="display:none">
      <h3>Professor — Enviar exercício (por disciplina)</h3>
      <div style="margin-top:8px">
        <label>Disciplina:</label><br>
        <select id="teacherSubject"></select>
      </div>

      <div style="margin-top:8px">
        <label>Você (Professor da disciplina):</label><br>
        <input id="teacherLabel" placeholder="Professor da disciplina (fixo)">
        <div class="muted" style="margin-top:6px">Não é necessário inserir nome real. Apenas para identificação rápida.</div>
      </div>

      <div style="margin-top:8px">
        <label>Título do exercício:</label><br>
        <input id="exerciseTitle" placeholder="Ex: Lista 1 — Álgebra">
      </div>

      <div style="margin-top:8px">
        <label>Descrição / instruções:</label><br>
        <textarea id="exerciseDesc" placeholder="Detalhes do exercício, prazo, observações..."></textarea>
      </div>

      <div style="margin-top:8px">
        <label>Anexar arquivo (qualquer formato):</label><br>
        <!-- input escondido, botão estilizado chama file picker -->
        <input type="file" id="exerciseFile" style="display:none">
        <div>
          <span id="exerciseFileName" class="muted small">Nenhum arquivo selecionado</span>
          <button id="pickExerciseFile" type="button" class="file-btn" style="margin-left:10px">Escolher arquivo</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="sendExerciseBtn">Publicar exercício</button>
      </div>
    </div>

    <!-- ALUNO -->
    <div id="studentForm" style="display:none">
      <h3>Aluno — Enviar solução</h3>
      <div class="muted">1) Selecione um exercício na lista à direita → 2) Preencha seus dados e anexe arquivo → 3) Envie.</div>

      <div style="margin-top:10px">
        <label>Exercício selecionado:</label><br>
        <div id="selectedExerciseInfo" class="muted">Nenhum exercício selecionado</div>
      </div>

      <div style="margin-top:10px">
        <label>Nome completo:</label><br>
        <input id="studentFullName" placeholder="Seu nome completo">
      </div>

      <div style="margin-top:10px">
        <label>Número do aluno (matrícula):</label><br>
        <input id="studentNumber" placeholder="Número / matrícula">
      </div>

      <div style="margin-top:10px">
        <label>Turma:</label><br>
        <input id="studentClass" placeholder="Ex: 3ºA">
      </div>

      <div style="margin-top:10px">
        <label>Anexar arquivo da solução (qualquer formato):</label><br>
        <input type="file" id="solutionFile" style="display:none">
        <div>
          <span id="solutionFileName" class="muted small">Nenhum arquivo selecionado</span>
          <button id="pickSolutionFile" type="button" class="file-btn" style="margin-left:10px">Escolher arquivo</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Observação (opcional):</label><br>
        <textarea id="solutionMsg" placeholder="Observações..."></textarea>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="sendSolutionBtn">Enviar solução</button>
        <button id="cancelSelectionBtn" class="btn-ghost" type="button" style="background:#fff;color:#333;border:1px solid #eee">Cancelar seleção</button>
      </div>
    </div>

    <div style="margin-top:16px" class="muted small">
      Observação: os botões "Escolher arquivo" abrem diretamente o armazenamento do seu dispositivo (telefone/computador).
    </div>
  </div>

  <!-- LISTA DE EXERCÍCIOS -->
  <div class="card right">
    <h3>Lista de exercícios</h3>
    <div id="exercisesContainer" class="muted">Carregando...</div>
  </div>
</div>

<footer>Dados salvos localmente no seu dispositivo (localStorage). Nenhum servidor envolvido.</footer>

<script>
/* ========= CONFIGURAÇÃO DE DISCIPLINAS ========== */
/* Use a lista solicitada. Cada disciplina tem apenas 1 professor (identificação genérica). */
const SUBJECTS = [
  'Matemática',
  'Português',
  'Inglês',
  'Francês',
  'Biologia',
  'Integração Social',
  'Filosofia',
  'Empreendedorismo',
  'Educação Física'
];

/* Chave do localStorage */
const STORAGE_KEY = 'portal_turma_exercises_v4';

/* Estado local */
let data = loadData(); // array de exercícios
let selectedExerciseId = null;

/* Elementos */
const roleSelect = document.getElementById('roleSelect');
const filterSubject = document.getElementById('filterSubject');
const searchInput = document.getElementById('searchInput');

const teacherForm = document.getElementById('teacherForm');
const studentForm = document.getElementById('studentForm');

const teacherSubject = document.getElementById('teacherSubject');
const teacherLabel = document.getElementById('teacherLabel');
const exerciseTitle = document.getElementById('exerciseTitle');
const exerciseDesc = document.getElementById('exerciseDesc');
const exerciseFile = document.getElementById('exerciseFile');
const pickExerciseFile = document.getElementById('pickExerciseFile');
const exerciseFileName = document.getElementById('exerciseFileName');
const sendExerciseBtn = document.getElementById('sendExerciseBtn');

const selectedExerciseInfo = document.getElementById('selectedExerciseInfo');
const studentFullName = document.getElementById('studentFullName');
const studentNumber = document.getElementById('studentNumber');
const studentClass = document.getElementById('studentClass');
const solutionFile = document.getElementById('solutionFile');
const pickSolutionFile = document.getElementById('pickSolutionFile');
const solutionFileName = document.getElementById('solutionFileName');
const solutionMsg = document.getElementById('solutionMsg');
const sendSolutionBtn = document.getElementById('sendSolutionBtn');
const cancelSelectionBtn = document.getElementById('cancelSelectionBtn');

const exercisesContainer = document.getElementById('exercisesContainer');

const clearStorageBtn = document.getElementById('clearStorageBtn');

/* POPULAR selects */
function populateSubjectSelects(){
  SUBJECTS.forEach(s => {
    const o1 = document.createElement('option'); o1.value = s; o1.textContent = s;
    filterSubject.appendChild(o1);
    const o2 = document.createElement('option'); o2.value = s; o2.textContent = s;
    teacherSubject.appendChild(o2);
  });
}
populateSubjectSelects();

/* Carregar e salvar dados */
function loadData(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch(e){ return []; }
}
function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* UTIL: converter arquivo para base64 (mantém mime e nome) */
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    if(!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = () => resolve({ name: file.name, mime: file.type, data: reader.result });
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* BOTÕES de escolher arquivo (mostram picker do dispositivo) */
pickExerciseFile.addEventListener('click', ()=> exerciseFile.click());
exerciseFile.addEventListener('change', ()=> {
  exerciseFileName.textContent = exerciseFile.files[0] ? exerciseFile.files[0].name : 'Nenhum arquivo selecionado';
});

pickSolutionFile.addEventListener('click', ()=> solutionFile.click());
solutionFile.addEventListener('change', ()=> {
  solutionFileName.textContent = solutionFile.files[0] ? solutionFile.files[0].name : 'Nenhum arquivo selecionado';
});

/* Limpar storage */
clearStorageBtn.addEventListener('click', ()=>{
  if(!confirm('Apagar todos os exercícios e soluções do armazenamento local?')) return;
  localStorage.removeItem(STORAGE_KEY);
  data = [];
  selectedExerciseId = null;
  renderExercises();
  alert('Dados apagados.');
});

/* Mudar papel (professor / aluno) */
roleSelect.addEventListener('change', updateRoleUI);
function updateRoleUI(){
  const role = roleSelect.value;
  teacherForm.style.display = role === 'teacher' ? 'block' : 'none';
  studentForm.style.display = role === 'student' ? 'block' : 'none';
  // limpar seleção de exercício para aluno quando mudar
  selectedExerciseId = null;
  selectedExerciseInfo.textContent = 'Nenhum exercício selecionado';
  renderExercises();
}
updateRoleUI();

/* PROFESSOR: publicar exercício */
sendExerciseBtn.addEventListener('click', async ()=>{
  const subj = teacherSubject.value;
  const profLabel = teacherLabel.value.trim() || ('Professor de ' + subj);
  const title = exerciseTitle.value.trim();
  const desc = exerciseDesc.value.trim();
  const file = exerciseFile.files[0] || null;

  if(!title || !desc) return alert('Preencha título e descrição do exercício.');

  const fileObj = await fileToBase64(file);

  const ex = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
    subject: subj,
    professorLabel: profLabel,
    title,
    desc,
    file: fileObj, // pode ser null
    createdAt: new Date().toISOString(),
    solutions: [] // array de soluções
  };

  data.unshift(ex);
  saveData();
  // limpar form
  exerciseTitle.value=''; exerciseDesc.value=''; exerciseFile.value=''; exerciseFileName.textContent='Nenhum arquivo selecionado';
  alert('Exercício publicado.');
  renderExercises();
});

/* ALUNO: enviar solução (para exercício selecionado) */
sendSolutionBtn.addEventListener('click', async ()=>{
  if(!selectedExerciseId) return alert('Selecione um exercício na lista antes de enviar sua solução.');
  const name = studentFullName.value.trim();
  const number = studentNumber.value.trim();
  const klass = studentClass.value.trim();
  const msg = solutionMsg.value.trim();
  const file = solutionFile.files[0] || null;

  if(!name || !number || !klass) return alert('Preencha nome completo, número e turma antes de enviar.');

  const fileObj = await fileToBase64(file);

  const sol = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2,6),
    studentName: name,
    studentNumber: number,
    studentClass: klass,
    msg,
    file: fileObj,
    sentAt: new Date().toISOString()
  };

  const idx = data.findIndex(x => x.id === selectedExerciseId);
  if(idx === -1) return alert('Exercício selecionado não encontrado.');

  data[idx].solutions.unshift(sol);
  saveData();

  // limpar form aluno
  studentFullName.value=''; studentNumber.value=''; studentClass.value=''; solutionMsg.value=''; solutionFile.value=''; solutionFileName.textContent='Nenhum arquivo selecionado';
  selectedExerciseId = null;
  selectedExerciseInfo.textContent = 'Nenhum exercício selecionado';
  alert('Solução enviada — registrada com nome e número.');
  renderExercises();
});

/* Cancelar seleção (aluno) */
cancelSelectionBtn.addEventListener('click', ()=>{
  selectedExerciseId = null;
  selectedExerciseInfo.textContent = 'Nenhum exercício selecionado';
  renderExercises();
});

/* DOWNLOAD helper */
function downloadBase64(fileObj){
  if(!fileObj || !fileObj.data) { alert('Arquivo não disponível.'); return; }
  const a = document.createElement('a');
  a.href = fileObj.data;
  a.download = fileObj.name || 'download';
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* RENDER: lista de exercícios */
function renderExercises(){
  // make sure data variable used (reload in case changed)
  data = loadData();

  const role = roleSelect.value;
  const filter = filterSubject.value;
  const q = (searchInput.value || '').trim().toLowerCase();

  let items = data.slice(); // clone
  if(filter) items = items.filter(x => x.subject === filter);
  if(q) items = items.filter(x => (x.title + ' ' + x.desc).toLowerCase().includes(q));

  if(items.length === 0){
    exercisesContainer.innerHTML = '<div class="muted">Nenhum exercício encontrado.</div>';
    return;
  }

  exercisesContainer.innerHTML = '';
  items.forEach(ex => {
    const box = document.createElement('div');
    box.className = 'exercise';

    // header
    const hdr = document.createElement('div');
    hdr.innerHTML = `<strong>${escapeHtml(ex.title)}</strong> <span class="small">[${escapeHtml(ex.subject)}]</span>
      <div class="muted small">${escapeHtml(ex.professorLabel)} — ${new Date(ex.createdAt).toLocaleString()}</div>
      <div style="margin-top:8px">${escapeHtml(ex.desc)}</div>`;
    box.appendChild(hdr);

    // arquivo exercício
    if(ex.file){
      const fbtn = document.createElement('button');
      fbtn.className = 'btn-ghost';
      fbtn.textContent = 'Baixar exercício (' + ex.file.name + ')';
      fbtn.onclick = ()=> downloadBase64(ex.file);
      fbtn.style.background = '#fff'; fbtn.style.color = '#111'; fbtn.style.border = '1px solid #eee'; fbtn.style.padding='6px 10px';
      box.appendChild(fbtn);
    }

    // actions
    const actions = document.createElement('div');
    actions.className = 'actions';

    // For teacher: view solutions and remove
    if(role === 'teacher'){
      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'Ver soluções (' + (ex.solutions.length || 0) + ')';
      viewBtn.onclick = ()=> toggleSolutions(box, ex.id);
      actions.appendChild(viewBtn);

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remover exercício';
      removeBtn.style.background = '#ef4444';
      removeBtn.onclick = ()=>{
        if(!confirm('Remover este exercício?')) return;
        data = data.filter(d => d.id !== ex.id);
        saveData();
        renderExercises();
      };
      actions.appendChild(removeBtn);
    }

    // For student: select exercise to send solution
    if(role === 'student'){
      const selectBtn = document.createElement('button');
      const isSelected = selectedExerciseId === ex.id;
      selectBtn.textContent = isSelected ? 'Exercício selecionado' : 'Selecionar exercício';
      selectBtn.onclick = ()=>{
        selectedExerciseId = ex.id;
        selectedExerciseInfo.textContent = ex.title + ' [' + ex.subject + ']';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        renderExercises();
      };
      selectBtn.style.background = isSelected ? '#10b981' : undefined;
      actions.appendChild(selectBtn);
    }

    box.appendChild(actions);

    // solutions panel placeholder (for professor)
    const solPanel = document.createElement('div');
    solPanel.className = 'solutions';
    solPanel.style.display = 'none';
    solPanel.id = 'sol_' + ex.id;
    box.appendChild(solPanel);

    exercisesContainer.appendChild(box);
  });
}

/* Toggle panel de soluções para professor */
function toggleSolutions(containerBox, exId){
  const panel = containerBox.querySelector('#sol_' + exId) || document.getElementById('sol_' + exId);
  if(!panel) return;
  if(panel.style.display === 'block'){ panel.style.display='none'; panel.innerHTML=''; return; }
  // montar conteúdo
  const ex = data.find(x => x.id === exId);
  panel.innerHTML = `<strong>Soluções (${ex.solutions.length})</strong>`;
  if(ex.solutions.length === 0){
    panel.innerHTML += '<div class="muted">Nenhuma solução enviada ainda.</div>';
  } else {
    ex.solutions.forEach(sol => {
      const div = document.createElement('div');
      div.style.borderTop = '1px solid #eee';
      div.style.paddingTop = '8px';
      div.innerHTML = `<div><b>${escapeHtml(sol.studentName)}</b> — Nº: ${escapeHtml(sol.studentNumber)} — Turma: ${escapeHtml(sol.studentClass)}</div>
                       <div class="muted small">${new Date(sol.sentAt).toLocaleString()}</div>
                       <div style="margin-top:6px">${escapeHtml(sol.msg)}</div>`;
      panel.appendChild(div);
      if(sol.file){
        const db = document.createElement('button');
        db.textContent = 'Baixar (' + sol.file.name + ')';
        db.style.marginTop = '8px';
        db.onclick = ()=> downloadBase64(sol.file);
        panel.appendChild(db);
      }
    });
  }
  panel.style.display = 'block';
}

/* Escape HTML simples */
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* FILTROS */
filterSubject.addEventListener('change', renderExercises);
searchInput.addEventListener('input', ()=> { if(window._to) clearTimeout(window._to); window._to = setTimeout(renderExercises, 150); });

/* Inicializar */
renderExercises();

/* Expõe uma função para recarregar (útil se editar localStorage manualmente) */
window.portalReload = ()=> { data = loadData(); renderExercises(); };

</script>
</body>
</html>
